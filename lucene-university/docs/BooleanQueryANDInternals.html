<!DOCTYPE html>

<html>
<head>
  <title>Conjunctive Boolean query (AND) internals</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="main">

      <div class="header">
        <h1>Conjunctive Boolean query (AND) internals</h1>

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="AnalyzerBasics.html">
                    AnalyzerBasics.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="BooleanQueryANDInternals.html">
                    BooleanQueryANDInternals.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="BooleanQueryIntro.html">
                    BooleanQueryIntro.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="BottomUpIndexReader.html">
                    BottomUpIndexReader.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="BytesRefHashExample.html">
                    BytesRefHashExample.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="CombinedFieldQueryExample.html">
                    CombinedFieldQueryExample.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="DirectoryFileContents.html">
                    DirectoryFileContents.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="DocValuesSearchExample.html">
                    DocValuesSearchExample.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="FunctionQuerySearchExample.html">
                    FunctionQuerySearchExample.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="KnnSearchExample.html">
                    KnnSearchExample.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="PointTreeRangeQuery.html">
                    PointTreeRangeQuery.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="PrimitivesRef.html">
                    PrimitivesRef.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="SearchWithTermsEnum.html">
                    SearchWithTermsEnum.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="SimpleSearch.html">
                    SimpleSearch.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="TextVectorSearchExample.html">
                    TextVectorSearchExample.java
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="VisualizePointTree.html">
                    VisualizePointTree.java
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>
      
        
        <p>This example partly builds on top of the concepts introduced in <code>BooleanQueryIntro</code>, so I suggest you go check
that example first.</p>
<p>If you happen to have arrived here through a web search, please <strong>DO NOT ACTUALLY USE THIS CODE</strong>. Lucene already
has a BooleanQuery class. See the neighboring <code>BooleanQueryIntro</code> example for some guidance on using it.</p>
<p>This example digs into some of the implementation details for Boolean queries, specifically conjunctive (<code>AND</code>)
queries. Since Lucene’s real Boolean queries are quite sophisticated, most of this example will involve building
our own version of a Boolean query that behaves like a binary “AND” operator. That is, it has exactly two clauses,
which are both required (and participate in scoring). Along the way, we’ll learn some things about how Lucene
queries in general are implemented, and how Boolean queries implement “leap-frogging”.</p>
<p>Before we get into the code, here is an overview of the chain of classes we need to implement for our own query:</p>
<ol>
<li><code>Query</code>: A query represents the instruction for <em>what</em> we want to match/score, without getting into the details
     of <em>how</em> we’re going to do so.</li>
<li><code>Weight</code>: Returned by the <code>createWeight</code> method on the query. The JavaDoc for <code>Weight</code> says, “The purpose of
     Weight is to ensure searching does not modify a Query, so that a Query instance can be reused.” While
     the <code>Query</code> is independent of any index state, the <code>Weight</code> is constructed based on the current
     <code>IndexSearcher</code>, and properties of the search action (e.g. whether scoring is needed).</li>
<li><code>Scorer</code>: For each index segment, the <code>Weight</code> creates a <code>Scorer</code>. The <code>Scorer</code> may be used once to step through
     matching documents in the segment (via its embedded <code>DocIdSetIterator</code> – explained next), and returns
     the score (at this query’s level) for the document.</li>
<li><code>DocIdSetIterator</code>: A <code>DocIdSetIterator</code> (often abbreviated to DISI) steps through matching document IDs for the
     given segment in increasing order. Many DISIs support an efficient <code>advance(int n)</code> method that returns
     the matching doc ID greater than or equal to <code>n</code>.</li>
</ol>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 29;"><span class="line" id="L29"><span style="color: #D32F2F">package</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">example</span><span style="color: #212121">.</span><span style="color: #D32F2F">basic</span><span style="color: #24292EFF">;</span></span>
<span class="line empty-line" id="L30"></span>
<span class="line" id="L31"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">document</span><span style="color: #212121">.</span><span style="color: #D32F2F">Field</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L32"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">document</span><span style="color: #212121">.</span><span style="color: #D32F2F">TextField</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L33"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">index</span><span style="color: #212121">.</span><span style="color: #D32F2F">DirectoryReader</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L34"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">index</span><span style="color: #212121">.</span><span style="color: #D32F2F">IndexReader</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L35"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">index</span><span style="color: #212121">.</span><span style="color: #D32F2F">IndexWriter</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L36"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">index</span><span style="color: #212121">.</span><span style="color: #D32F2F">IndexWriterConfig</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L37"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">index</span><span style="color: #212121">.</span><span style="color: #D32F2F">LeafReaderContext</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L38"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">index</span><span style="color: #212121">.</span><span style="color: #D32F2F">Term</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L39"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">BooleanClause</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L40"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">DocIdSetIterator</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L41"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">Explanation</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L42"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">IndexSearcher</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L43"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">Query</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L44"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">QueryVisitor</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L45"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">ScoreDoc</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L46"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">ScoreMode</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L47"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">Scorer</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L48"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">ScorerSupplier</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L49"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">TermQuery</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L50"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">TopDocs</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L51"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">Weight</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L52"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">similarities</span><span style="color: #212121">.</span><span style="color: #D32F2F">BasicStats</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L53"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">search</span><span style="color: #212121">.</span><span style="color: #D32F2F">similarities</span><span style="color: #212121">.</span><span style="color: #D32F2F">SimilarityBase</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L54"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">store</span><span style="color: #212121">.</span><span style="color: #D32F2F">Directory</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L55"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">org</span><span style="color: #212121">.</span><span style="color: #D32F2F">apache</span><span style="color: #212121">.</span><span style="color: #D32F2F">lucene</span><span style="color: #212121">.</span><span style="color: #D32F2F">store</span><span style="color: #212121">.</span><span style="color: #D32F2F">FSDirectory</span><span style="color: #24292EFF">;</span></span>
<span class="line empty-line" id="L56"></span>
<span class="line" id="L57"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">java</span><span style="color: #212121">.</span><span style="color: #D32F2F">io</span><span style="color: #212121">.</span><span style="color: #D32F2F">IOException</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L58"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">java</span><span style="color: #212121">.</span><span style="color: #D32F2F">nio</span><span style="color: #212121">.</span><span style="color: #D32F2F">file</span><span style="color: #212121">.</span><span style="color: #D32F2F">Files</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L59"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">java</span><span style="color: #212121">.</span><span style="color: #D32F2F">nio</span><span style="color: #212121">.</span><span style="color: #D32F2F">file</span><span style="color: #212121">.</span><span style="color: #D32F2F">Path</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L60"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">java</span><span style="color: #212121">.</span><span style="color: #D32F2F">util</span><span style="color: #212121">.</span><span style="color: #D32F2F">ArrayList</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L61"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">java</span><span style="color: #212121">.</span><span style="color: #D32F2F">util</span><span style="color: #212121">.</span><span style="color: #D32F2F">List</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L62"><span style="color: #D32F2F">import</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">java</span><span style="color: #212121">.</span><span style="color: #D32F2F">util</span><span style="color: #212121">.</span><span style="color: #D32F2F">Objects</span><span style="color: #24292EFF">;</span></span>
<span class="line empty-line" id="L63"></span>
<span class="line" id="L64"><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">class</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">BooleanQueryANDInternals</span><span style="color: #24292EFF"> {</span></span>
<span class="line empty-line" id="L65"></span></code></pre>
      
        
        <h2 id="document-construction">Document construction</h2>

        
      
        
        <p>We’ll reuse the documents from <code>BooleanQueryIntro</code>. In brief, the documents contain the words for their
prime factors less than 10.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 70;"><span class="line" id="L70"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">static</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">List&lt;</span><span style="color: #24292EFF">String</span><span style="color: #D32F2F">&gt;</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">createDocumentText(</span><span style="color: #D32F2F">int</span><span style="color: #6F42C1"> numDocs)</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L71"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">List</span><span style="color: #24292EFF">&lt;</span><span style="color: #D32F2F">String</span><span style="color: #24292EFF">&gt; docs </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">ArrayList</span><span style="color: #24292EFF">&lt;&gt;();</span></span>
<span class="line" id="L72"><span style="color: #24292EFF">        </span><span style="color: #1976D2">docs</span><span style="color: #212121">.</span><span style="color: #6F42C1">add</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&quot;zero&quot;</span><span style="color: #24292EFF">); </span><span style="color: #C2C3C5">/* First doc will just have &quot;zero&quot;, since the first doc ID is 0 */</span></span>
<span class="line" id="L73"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">for</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">int</span><span style="color: #24292EFF"> i </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">1</span><span style="color: #24292EFF">; i </span><span style="color: #D32F2F">&lt;</span><span style="color: #24292EFF"> numDocs; i</span><span style="color: #D32F2F">++</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L74"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">StringBuilder</span><span style="color: #24292EFF"> sb </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">StringBuilder()</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L75"><span style="color: #24292EFF">            </span><span style="color: #1976D2">sb</span><span style="color: #212121">.</span><span style="color: #6F42C1">append</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&quot;one&quot;</span><span style="color: #24292EFF">);</span></span>
<span class="line" id="L76"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (i </span><span style="color: #D32F2F">%</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">2</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">==</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">0</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L77"><span style="color: #24292EFF">                </span><span style="color: #1976D2">sb</span><span style="color: #212121">.</span><span style="color: #6F42C1">append</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&quot; two&quot;</span><span style="color: #24292EFF">);</span></span>
<span class="line" id="L78"><span style="color: #24292EFF">            }</span></span>
<span class="line" id="L79"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (i </span><span style="color: #D32F2F">%</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">3</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">==</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">0</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L80"><span style="color: #24292EFF">                </span><span style="color: #1976D2">sb</span><span style="color: #212121">.</span><span style="color: #6F42C1">append</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&quot; three&quot;</span><span style="color: #24292EFF">);</span></span>
<span class="line" id="L81"><span style="color: #24292EFF">            }</span></span>
<span class="line" id="L82"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (i </span><span style="color: #D32F2F">%</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">5</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">==</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">0</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L83"><span style="color: #24292EFF">                </span><span style="color: #1976D2">sb</span><span style="color: #212121">.</span><span style="color: #6F42C1">append</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&quot; five&quot;</span><span style="color: #24292EFF">);</span></span>
<span class="line" id="L84"><span style="color: #24292EFF">            }</span></span>
<span class="line" id="L85"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (i </span><span style="color: #D32F2F">%</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">7</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">==</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">0</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L86"><span style="color: #24292EFF">                </span><span style="color: #1976D2">sb</span><span style="color: #212121">.</span><span style="color: #6F42C1">append</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&quot; seven&quot;</span><span style="color: #24292EFF">);</span></span>
<span class="line" id="L87"><span style="color: #24292EFF">            }</span></span>
<span class="line" id="L88"><span style="color: #24292EFF">            </span><span style="color: #1976D2">docs</span><span style="color: #212121">.</span><span style="color: #6F42C1">add</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">sb</span><span style="color: #212121">.</span><span style="color: #6F42C1">toString</span><span style="color: #24292EFF">());</span></span>
<span class="line" id="L89"><span style="color: #24292EFF">        }</span></span>
<span class="line" id="L90"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> docs;</span></span>
<span class="line" id="L91"><span style="color: #24292EFF">    }</span></span>
<span class="line empty-line" id="L92"></span>
<span class="line empty-line" id="L93"></span></code></pre>
      
        
        <h2 id="query-class">Query class</h2>

        
      
        
        <p>Let’s start with our custom query class. Since we want to represent the specific <code>a AND b</code> case, we will
explicitly take <code>a</code> and <code>b</code> as “left” and “right” operands.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 98;"><span class="line" id="L98"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">static</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">final</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">class</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">BinaryAndQuery</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">extends</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">Query</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L99"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">final</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">Query</span><span style="color: #24292EFF"> left;</span></span>
<span class="line" id="L100"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">final</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">Query</span><span style="color: #24292EFF"> right;</span></span>
<span class="line empty-line" id="L101"></span>
<span class="line" id="L102"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">BinaryAndQuery</span><span style="color: #24292EFF">(</span><span style="color: #D32F2F">Query</span><span style="color: #24292EFF"> left</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">Query</span><span style="color: #24292EFF"> right) {</span></span>
<span class="line" id="L103"><span style="color: #24292EFF">            </span><span style="color: #1976D2">this</span><span style="color: #212121">.</span><span style="color: #1976D2">left</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Objects</span><span style="color: #212121">.</span><span style="color: #6F42C1">requireNonNull</span><span style="color: #24292EFF">(left);</span></span>
<span class="line" id="L104"><span style="color: #24292EFF">            </span><span style="color: #1976D2">this</span><span style="color: #212121">.</span><span style="color: #1976D2">right</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Objects</span><span style="color: #212121">.</span><span style="color: #6F42C1">requireNonNull</span><span style="color: #24292EFF">(right);</span></span>
<span class="line" id="L105"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L106"></span>
<span class="line empty-line" id="L107"></span></code></pre>
      
        
        <p>A query should implement a friendly <code>toString</code> method that provides a human-readable representation.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 108;"><span class="line" id="L108"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L109"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">String</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">toString(</span><span style="color: #D32F2F">String</span><span style="color: #6F42C1"> field)</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L110"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">left</span><span style="color: #212121">.</span><span style="color: #6F42C1">toString</span><span style="color: #24292EFF">(field) </span><span style="color: #D32F2F">+</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&quot; AND &quot;</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">+</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">right</span><span style="color: #212121">.</span><span style="color: #6F42C1">toString</span><span style="color: #24292EFF">(field);</span></span>
<span class="line" id="L111"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L112"></span>
<span class="line empty-line" id="L113"></span></code></pre>
      
        
        <p>To allow operations on complex query hierarchies, queries are expected to take a <code>QueryVisitor</code> and pass
it down the tree. The “leaf” queries at the end of a query hierarchy should call <code>visitor.visitLeaf(this)</code>.
Functionally, this implementation is identical to what <code>BooleanQuery</code> will do with a pair of <code>MUST</code> clauses.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 116;"><span class="line" id="L116"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L117"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">void</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">visit(</span><span style="color: #D32F2F">QueryVisitor</span><span style="color: #6F42C1"> visitor)</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L118"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">QueryVisitor</span><span style="color: #24292EFF"> childVisitor </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">visitor</span><span style="color: #212121">.</span><span style="color: #6F42C1">getSubVisitor</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">BooleanClause</span><span style="color: #212121">.</span><span style="color: #1976D2">Occur</span><span style="color: #212121">.</span><span style="color: #1976D2">MUST</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">this</span><span style="color: #24292EFF">);</span></span>
<span class="line" id="L119"><span style="color: #24292EFF">            </span><span style="color: #1976D2">left</span><span style="color: #212121">.</span><span style="color: #6F42C1">visit</span><span style="color: #24292EFF">(childVisitor);</span></span>
<span class="line" id="L120"><span style="color: #24292EFF">            </span><span style="color: #1976D2">right</span><span style="color: #212121">.</span><span style="color: #6F42C1">visit</span><span style="color: #24292EFF">(childVisitor);</span></span>
<span class="line" id="L121"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L122"></span>
<span class="line empty-line" id="L123"></span></code></pre>
      
        
        <p>Since a <code>Query</code> may be used as a hash key (e.g. if the results of the query are cached), they are expected
to correctly implement <code>equals</code> and <code>hashCode</code>.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 125;"><span class="line" id="L125"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L126"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">boolean</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">equals(</span><span style="color: #D32F2F">Object</span><span style="color: #6F42C1"> o)</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L127"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #1976D2">this</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">==</span><span style="color: #24292EFF"> o) </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">true</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L128"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (o </span><span style="color: #D32F2F">==</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">null</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">||</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">getClass()</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">!=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">o</span><span style="color: #212121">.</span><span style="color: #6F42C1">getClass</span><span style="color: #24292EFF">()) </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">false</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L129"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">BinaryAndQuery</span><span style="color: #24292EFF"> that </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> (BinaryAndQuery) o;</span></span>
<span class="line" id="L130"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Objects</span><span style="color: #212121">.</span><span style="color: #6F42C1">equals</span><span style="color: #24292EFF">(left</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">that</span><span style="color: #212121">.</span><span style="color: #1976D2">left</span><span style="color: #24292EFF">) </span><span style="color: #D32F2F">&amp;&amp;</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Objects</span><span style="color: #212121">.</span><span style="color: #6F42C1">equals</span><span style="color: #24292EFF">(right</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">that</span><span style="color: #212121">.</span><span style="color: #1976D2">right</span><span style="color: #24292EFF">);</span></span>
<span class="line" id="L131"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L132"></span>
<span class="line" id="L133"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L134"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">int</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">hashCode()</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L135"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Objects</span><span style="color: #212121">.</span><span style="color: #6F42C1">hash</span><span style="color: #24292EFF">(left</span><span style="color: #212121">,</span><span style="color: #24292EFF"> right);</span></span>
<span class="line" id="L136"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L137"></span>
<span class="line empty-line" id="L138"></span></code></pre>
      
        
        <p>Finally, when it comes time to search with our query, we create the <code>Weight</code> instance. Note that
we need to call <code>createWeight</code> on each of our nested queries, too. Note that while we could call
<code>createWeight</code> on the <code>left</code> and <code>right</code> queries directly, it is more correct to delegate to the <code>searcher</code>,
which may have one of the nested queries in its cache. (See the <code>isCacheable</code> method in <code>BinaryAndWeight</code>,
below.)</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 143;"><span class="line" id="L143"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L144"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">Weight</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">createWeight(</span><span style="color: #D32F2F">IndexSearcher</span><span style="color: #6F42C1"> searcher</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #D32F2F">ScoreMode</span><span style="color: #6F42C1"> scoreMode</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #D32F2F">float</span><span style="color: #6F42C1"> boost)</span><span style="color: #24292EFF"> throws IOException {</span></span>
<span class="line" id="L145"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">BinaryAndWeight(</span><span style="color: #1976D2">this</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #1976D2">searcher</span><span style="color: #212121">.</span><span style="color: #6F42C1">createWeight(left</span><span style="color: #212121">,</span><span style="color: #6F42C1"> scoreMode</span><span style="color: #212121">,</span><span style="color: #6F42C1"> boost)</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #1976D2">searcher</span><span style="color: #212121">.</span><span style="color: #6F42C1">createWeight(right</span><span style="color: #212121">,</span><span style="color: #6F42C1"> scoreMode</span><span style="color: #212121">,</span><span style="color: #6F42C1"> boost))</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L146"><span style="color: #24292EFF">        }</span></span>
<span class="line" id="L147"><span style="color: #24292EFF">    }</span></span>
<span class="line empty-line" id="L148"></span>
<span class="line empty-line" id="L149"></span></code></pre>
      
        
        <h2 id="weight-class">Weight class</h2>

        
      
        
        <p>For our purposes, the role of the <code>Weight</code> implementation is to hold the <code>Weight</code> instances for the operands,
create the <code>Scorer</code> for each segment, and implement the <code>explain</code> method.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 154;"><span class="line" id="L154"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">static</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">class</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">BinaryAndWeight</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">extends</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">Weight</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L155"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">final</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">Weight</span><span style="color: #24292EFF"> leftWeight;</span></span>
<span class="line" id="L156"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">final</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">Weight</span><span style="color: #24292EFF"> rightWeight;</span></span>
<span class="line empty-line" id="L157"></span>
<span class="line" id="L158"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">BinaryAndWeight</span><span style="color: #24292EFF">(</span><span style="color: #D32F2F">Query</span><span style="color: #24292EFF"> query</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">Weight</span><span style="color: #24292EFF"> leftWeight</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">Weight</span><span style="color: #24292EFF"> rightWeight) {</span></span>
<span class="line" id="L159"><span style="color: #24292EFF">            super(query);</span></span>
<span class="line" id="L160"><span style="color: #24292EFF">            </span><span style="color: #1976D2">this</span><span style="color: #212121">.</span><span style="color: #1976D2">leftWeight</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> leftWeight;</span></span>
<span class="line" id="L161"><span style="color: #24292EFF">            </span><span style="color: #1976D2">this</span><span style="color: #212121">.</span><span style="color: #1976D2">rightWeight</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> rightWeight;</span></span>
<span class="line" id="L162"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L163"></span>
<span class="line empty-line" id="L164"></span></code></pre>
      
        
        <p>Every <code>Weight</code> is expected to implement the <code>explain</code> method to show how a given document’s score was
derived (or to explain why a non-matching document did not match).</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 166;"><span class="line" id="L166"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L167"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">Explanation</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">explain(</span><span style="color: #D32F2F">LeafReaderContext</span><span style="color: #6F42C1"> context</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #D32F2F">int</span><span style="color: #6F42C1"> doc)</span><span style="color: #24292EFF"> throws IOException {</span></span>
<span class="line" id="L168"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">Explanation</span><span style="color: #24292EFF"> leftExplain </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">leftWeight</span><span style="color: #212121">.</span><span style="color: #6F42C1">explain</span><span style="color: #24292EFF">(context</span><span style="color: #212121">,</span><span style="color: #24292EFF"> doc);</span></span>
<span class="line" id="L169"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">Explanation</span><span style="color: #24292EFF"> rightExplain </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">rightWeight</span><span style="color: #212121">.</span><span style="color: #6F42C1">explain</span><span style="color: #24292EFF">(context</span><span style="color: #212121">,</span><span style="color: #24292EFF"> doc);</span></span>
<span class="line" id="L170"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">!</span><span style="color: #1976D2">leftExplain</span><span style="color: #212121">.</span><span style="color: #6F42C1">isMatch</span><span style="color: #24292EFF">()) {</span></span>
<span class="line" id="L171"><span style="color: #24292EFF">                </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Explanation</span><span style="color: #212121">.</span><span style="color: #6F42C1">noMatch</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&quot;no match on required clause (&quot;</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">+</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">leftWeight</span><span style="color: #212121">.</span><span style="color: #6F42C1">getQuery</span><span style="color: #24292EFF">()</span><span style="color: #212121">.</span><span style="color: #6F42C1">toString</span><span style="color: #24292EFF">() </span><span style="color: #D32F2F">+</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&quot;)&quot;</span><span style="color: #212121">,</span><span style="color: #24292EFF"> leftExplain);</span></span>
<span class="line" id="L172"><span style="color: #24292EFF">            } </span><span style="color: #D32F2F">else</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">!</span><span style="color: #1976D2">rightExplain</span><span style="color: #212121">.</span><span style="color: #6F42C1">isMatch</span><span style="color: #24292EFF">()) {</span></span>
<span class="line" id="L173"><span style="color: #24292EFF">                </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Explanation</span><span style="color: #212121">.</span><span style="color: #6F42C1">noMatch</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&quot;no match on required clause (&quot;</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">+</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">rightWeight</span><span style="color: #212121">.</span><span style="color: #6F42C1">getQuery</span><span style="color: #24292EFF">()</span><span style="color: #212121">.</span><span style="color: #6F42C1">toString</span><span style="color: #24292EFF">() </span><span style="color: #D32F2F">+</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&quot;)&quot;</span><span style="color: #212121">,</span><span style="color: #24292EFF"> rightExplain);</span></span>
<span class="line" id="L174"><span style="color: #24292EFF">            }</span></span>
<span class="line" id="L175"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">Scorer</span><span style="color: #24292EFF"> scorer </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">scorer(context)</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L176"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">int</span><span style="color: #24292EFF"> advanced </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">scorer</span><span style="color: #212121">.</span><span style="color: #6F42C1">iterator</span><span style="color: #24292EFF">()</span><span style="color: #212121">.</span><span style="color: #6F42C1">advance</span><span style="color: #24292EFF">(doc);</span></span>
<span class="line" id="L177"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">assert</span><span style="color: #24292EFF"> advanced </span><span style="color: #D32F2F">==</span><span style="color: #24292EFF"> doc;</span></span>
<span class="line" id="L178"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Explanation</span><span style="color: #212121">.</span><span style="color: #6F42C1">match</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">scorer</span><span style="color: #212121">.</span><span style="color: #6F42C1">score</span><span style="color: #24292EFF">()</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&quot;sum of:&quot;</span><span style="color: #212121">,</span><span style="color: #24292EFF"> leftExplain</span><span style="color: #212121">,</span><span style="color: #24292EFF"> rightExplain);</span></span>
<span class="line" id="L179"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L180"></span>
<span class="line empty-line" id="L181"></span></code></pre>
      
        
        <p>We return our custom <code>Scorer</code> implementation for a given index segment, after creating the scorers for
each of our operands.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 183;"><span class="line" id="L183"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L184"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">ScorerSupplier</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">scorerSupplier(</span><span style="color: #D32F2F">LeafReaderContext</span><span style="color: #6F42C1"> context)</span><span style="color: #24292EFF"> throws IOException {</span></span>
<span class="line" id="L185"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">ScorerSupplier</span><span style="color: #24292EFF"> leftScorerSupplier </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">leftWeight</span><span style="color: #212121">.</span><span style="color: #6F42C1">scorerSupplier</span><span style="color: #24292EFF">(context);</span></span>
<span class="line" id="L186"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">ScorerSupplier</span><span style="color: #24292EFF"> rightScorerSupplier </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">rightWeight</span><span style="color: #212121">.</span><span style="color: #6F42C1">scorerSupplier</span><span style="color: #24292EFF">(context);</span></span>
<span class="line" id="L187"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">Weight</span><span style="color: #24292EFF"> weight </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">this</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L188"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">ScorerSupplier()</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L189"><span style="color: #24292EFF">                @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L190"><span style="color: #24292EFF">                </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">Scorer</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">get</span><span style="color: #24292EFF">(</span><span style="color: #D32F2F">long</span><span style="color: #24292EFF"> l) </span><span style="color: #D32F2F">throws</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">IOException</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L191"><span style="color: #24292EFF">                    </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">BinaryAndScorer(weight</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #1976D2">leftScorerSupplier</span><span style="color: #212121">.</span><span style="color: #6F42C1">get(l)</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #1976D2">rightScorerSupplier</span><span style="color: #212121">.</span><span style="color: #6F42C1">get(l))</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L192"><span style="color: #24292EFF">                }</span></span>
<span class="line empty-line" id="L193"></span>
<span class="line" id="L194"><span style="color: #24292EFF">                @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L195"><span style="color: #24292EFF">                </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">long</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">cost</span><span style="color: #24292EFF">() {</span></span>
<span class="line empty-line" id="L196"></span></code></pre>
      
        
        <p>Worst case, we match everything from left and right.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 197;"><span class="line" id="L197"><span style="color: #24292EFF">                    </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">leftScorerSupplier</span><span style="color: #212121">.</span><span style="color: #6F42C1">cost</span><span style="color: #24292EFF">() </span><span style="color: #D32F2F">+</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">rightScorerSupplier</span><span style="color: #212121">.</span><span style="color: #6F42C1">cost</span><span style="color: #24292EFF">();</span></span>
<span class="line" id="L198"><span style="color: #24292EFF">                }</span></span>
<span class="line" id="L199"><span style="color: #24292EFF">            };</span></span>
<span class="line" id="L200"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L201"></span>
<span class="line empty-line" id="L202"></span></code></pre>
      
        
        <p>The <code>IndexSearcher</code> holds a <code>QueryCache</code> instance that may store the matching doc IDs for a given query.
Not all queries are readily cacheable, though, so the <code>IndexSearcher</code> asks the weight if it is cacheable
or not.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 205;"><span class="line" id="L205"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L206"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">boolean</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">isCacheable(</span><span style="color: #D32F2F">LeafReaderContext</span><span style="color: #6F42C1"> ctx)</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L207"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">leftWeight</span><span style="color: #212121">.</span><span style="color: #6F42C1">isCacheable</span><span style="color: #24292EFF">(ctx) </span><span style="color: #D32F2F">&amp;&amp;</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">rightWeight</span><span style="color: #212121">.</span><span style="color: #6F42C1">isCacheable</span><span style="color: #24292EFF">(ctx);</span></span>
<span class="line" id="L208"><span style="color: #24292EFF">        }</span></span>
<span class="line" id="L209"><span style="color: #24292EFF">    }</span></span>
<span class="line empty-line" id="L210"></span>
<span class="line empty-line" id="L211"></span></code></pre>
      
        
        <h3 id="scorer-class">Scorer class</h3>

        
      
        
        <p>Next, we need to implement the <code>Scorer</code> class. Most of the interesting logic lives in the <code>Scorer</code>‘s associated
<code>DocIdSetIterator</code>.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 215;"><span class="line" id="L215"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">static</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">class</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">BinaryAndScorer</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">extends</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">Scorer</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L216"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">final</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">Scorer</span><span style="color: #24292EFF"> leftScorer;</span></span>
<span class="line" id="L217"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">final</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">Scorer</span><span style="color: #24292EFF"> rightScorer;</span></span>
<span class="line" id="L218"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">final</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">DocIdSetIterator</span><span style="color: #24292EFF"> docIdSetIterator;</span></span>
<span class="line empty-line" id="L219"></span>
<span class="line" id="L220"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">BinaryAndScorer</span><span style="color: #24292EFF">(</span><span style="color: #D32F2F">Weight</span><span style="color: #24292EFF"> weight</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">Scorer</span><span style="color: #24292EFF"> leftScorer</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">Scorer</span><span style="color: #24292EFF"> rightScorer) {</span></span>
<span class="line" id="L221"><span style="color: #24292EFF">            </span><span style="color: #1976D2">this</span><span style="color: #212121">.</span><span style="color: #1976D2">leftScorer</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> leftScorer;</span></span>
<span class="line" id="L222"><span style="color: #24292EFF">            </span><span style="color: #1976D2">this</span><span style="color: #212121">.</span><span style="color: #1976D2">rightScorer</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> rightScorer;</span></span>
<span class="line" id="L223"><span style="color: #24292EFF">            </span><span style="color: #1976D2">this</span><span style="color: #212121">.</span><span style="color: #1976D2">docIdSetIterator</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">BinaryAndDocIdSetIterator(</span><span style="color: #1976D2">leftScorer</span><span style="color: #212121">.</span><span style="color: #6F42C1">iterator()</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #1976D2">rightScorer</span><span style="color: #212121">.</span><span style="color: #6F42C1">iterator())</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L224"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L225"></span>
<span class="line empty-line" id="L226"></span></code></pre>
      
        
        <p>If this scorer is pointing at a doc ID, then both the left and right scorers must be pointing at the
same doc ID (since it’s the current match for the left AND right).</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 228;"><span class="line" id="L228"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L229"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">int</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">docID()</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L230"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">assert</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">leftScorer</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">() </span><span style="color: #D32F2F">==</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">rightScorer</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">();</span></span>
<span class="line" id="L231"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">docIdSetIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">();</span></span>
<span class="line" id="L232"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L233"></span>
<span class="line" id="L234"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L235"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">DocIdSetIterator</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">iterator()</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L236"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> docIdSetIterator;</span></span>
<span class="line" id="L237"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L238"></span>
<span class="line empty-line" id="L239"></span></code></pre>
      
        
        <p>This <code>getMaxScore</code> can be used to skip entire blocks of uncompetitive documents, by providing an upper bound
on the possible score of a match. In this case, we ask each of our subscorers what their maximum scores
are <code>upTo</code> some future target and sum them together. But the max from <code>left</code> and the max from <code>right</code> might
not come from the same document, so there may not actually be a document with this score. That’s okay,
though – the skipping is a best-effort optimization.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 244;"><span class="line" id="L244"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L245"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">float</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">getMaxScore(</span><span style="color: #D32F2F">int</span><span style="color: #6F42C1"> upTo)</span><span style="color: #24292EFF"> throws IOException {</span></span>
<span class="line" id="L246"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">leftScorer</span><span style="color: #212121">.</span><span style="color: #6F42C1">getMaxScore</span><span style="color: #24292EFF">(upTo) </span><span style="color: #D32F2F">+</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">rightScorer</span><span style="color: #212121">.</span><span style="color: #6F42C1">getMaxScore</span><span style="color: #24292EFF">(upTo);</span></span>
<span class="line" id="L247"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L248"></span>
<span class="line empty-line" id="L249"></span></code></pre>
      
        
        <p>Consistent with BooleanQuery (using MUST clauses), we sum up the scores of our individual clauses.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 250;"><span class="line" id="L250"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L251"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">float</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">score()</span><span style="color: #24292EFF"> throws IOException {</span></span>
<span class="line" id="L252"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">assert</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">leftScorer</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">() </span><span style="color: #D32F2F">==</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">rightScorer</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">();</span></span>
<span class="line" id="L253"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">leftScorer</span><span style="color: #212121">.</span><span style="color: #6F42C1">score</span><span style="color: #24292EFF">() </span><span style="color: #D32F2F">+</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">rightScorer</span><span style="color: #212121">.</span><span style="color: #6F42C1">score</span><span style="color: #24292EFF">();</span></span>
<span class="line" id="L254"><span style="color: #24292EFF">        }</span></span>
<span class="line" id="L255"><span style="color: #24292EFF">    }</span></span>
<span class="line empty-line" id="L256"></span>
<span class="line empty-line" id="L257"></span>
<span class="line empty-line" id="L258"></span></code></pre>
      
        
        <h2 id="the-docidsetiterator-class">The DocIdSetIterator class</h2>

        
      
        
        <p>This class is really the whole reason for this example (though the journey was hopefully informative too).
The DocIdSetIterator (DISI) classes are fundamental to Lucene’s matching logic.</p>
<p>Conjunctions of required clauses (like our AND query) step through all documents where all of their underlying
DISIs point to the same thing. We achieve this with the (generally) fast <code>advance</code> method, asking a DISI
that’s behind to skip to the first value greater than or equal to the DISI that’s in the lead. If they point
to the same thing, then we have a match and return it. Otherwise, the old lead is now behind and it can leap
over the new lead, like a game of leapfrog.</p>
<p>Note that our <code>advance</code> and <code>nextDoc</code> methods guarantee that they only return when <code>leftIterator</code> and
<code>rightIterator</code> point to the same value (though that value may be <code>NO_MORE_DOCS</code>).</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 271;"><span class="line" id="L271"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">static</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">class</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">BinaryAndDocIdSetIterator</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">extends</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">DocIdSetIterator</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L272"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">final</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">DocIdSetIterator</span><span style="color: #24292EFF"> leftIterator;</span></span>
<span class="line" id="L273"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">final</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">DocIdSetIterator</span><span style="color: #24292EFF"> rightIterator;</span></span>
<span class="line empty-line" id="L274"></span>
<span class="line" id="L275"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">BinaryAndDocIdSetIterator</span><span style="color: #24292EFF">(</span><span style="color: #D32F2F">DocIdSetIterator</span><span style="color: #24292EFF"> leftIterator</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">DocIdSetIterator</span><span style="color: #24292EFF"> rightIterator) {</span></span>
<span class="line" id="L276"><span style="color: #24292EFF">            </span><span style="color: #1976D2">this</span><span style="color: #212121">.</span><span style="color: #1976D2">leftIterator</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> leftIterator;</span></span>
<span class="line" id="L277"><span style="color: #24292EFF">            </span><span style="color: #1976D2">this</span><span style="color: #212121">.</span><span style="color: #1976D2">rightIterator</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> rightIterator;</span></span>
<span class="line" id="L278"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L279"></span>
<span class="line empty-line" id="L280"></span></code></pre>
      
        
        <p>We can (and do) check the invariant that the left and right iterators are pointing to the same doc,
and return the left doc ID.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 282;"><span class="line" id="L282"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L283"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">int</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">docID()</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L284"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">assert</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">leftIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">() </span><span style="color: #D32F2F">==</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">rightIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">();</span></span>
<span class="line" id="L285"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">leftIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">();</span></span>
<span class="line" id="L286"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L287"></span>
<span class="line empty-line" id="L288"></span></code></pre>
      
        
        <p>For <code>nextDoc</code>, we arbitrarily step to the next document with <code>leftIterator</code>, then jump over to our
leapfrogging logic in <code>doNext</code>.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 290;"><span class="line" id="L290"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L291"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">int</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">nextDoc()</span><span style="color: #24292EFF"> throws IOException {</span></span>
<span class="line" id="L292"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">doNext(</span><span style="color: #1976D2">leftIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">nextDoc())</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L293"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L294"></span>
<span class="line empty-line" id="L295"></span></code></pre>
      
        
        <p>As with <code>nextDoc</code>, we can <code>advance</code> the <code>leftIterator</code> and leapfrog in <code>doNext</code> until the iterators
converge.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 297;"><span class="line" id="L297"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L298"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">int</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">advance(</span><span style="color: #D32F2F">int</span><span style="color: #6F42C1"> target)</span><span style="color: #24292EFF"> throws IOException {</span></span>
<span class="line" id="L299"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">doNext(</span><span style="color: #1976D2">leftIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">advance(target))</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L300"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L301"></span>
<span class="line empty-line" id="L302"></span></code></pre>
      
        
        <p>Here it is, the exciting part of the example and one of the most important concepts in Lucene.
The left and right iterators jump over each other, with the lagging iterator advancing to the
first doc ID greater than or equal to the leading iterator. Several of the built-in query types (including
TermQuery) have efficient <code>advance</code> methods that can return in logarithmic time.</p>
<p>This <code>while</code> loop is guaranteed to terminate, because eventually both iterators will point to <code>NO_MORE_DOCS</code>,
and passing <code>NO_MORE_DOCS</code> to an <code>advance</code> call is expected to return <code>NO_MORE_DOCS</code>. (The comparators work
because <code>NO_MORE_DOCS</code> is equal to <code>Integer.MAX_VALUE</code>.)</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 310;"><span class="line" id="L310"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">int</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">doNext(</span><span style="color: #D32F2F">int</span><span style="color: #6F42C1"> target)</span><span style="color: #24292EFF"> throws IOException {</span></span>
<span class="line" id="L311"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">while</span><span style="color: #24292EFF"> (</span><span style="color: #1976D2">leftIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">() </span><span style="color: #D32F2F">!=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">rightIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">()) {</span></span>
<span class="line" id="L312"><span style="color: #24292EFF">                </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #1976D2">rightIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">() </span><span style="color: #D32F2F">&lt;</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">leftIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">()) {</span></span>
<span class="line" id="L313"><span style="color: #24292EFF">                    </span><span style="color: #1976D2">rightIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">advance</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">leftIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">());</span></span>
<span class="line" id="L314"><span style="color: #24292EFF">                } </span><span style="color: #D32F2F">else</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L315"><span style="color: #24292EFF">                    </span><span style="color: #1976D2">leftIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">advance</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">rightIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">());</span></span>
<span class="line" id="L316"><span style="color: #24292EFF">                }</span></span>
<span class="line" id="L317"><span style="color: #24292EFF">            }</span></span>
<span class="line" id="L318"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">leftIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">docID</span><span style="color: #24292EFF">();</span></span>
<span class="line" id="L319"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L320"></span>
<span class="line empty-line" id="L321"></span></code></pre>
      
        
        <p>The <code>cost()</code> of a DISI is a measure of how expensive it would be to step through it fully, generally
corresponding to an upper bound on the number of docs the DISI matches. We don’t know how many documents
are in the intersection of <code>left</code> and <code>right</code> without stepping through them, but we know that the
intersection of <code>left</code> and <code>right</code> is definitely no bigger than whichever is smaller. (Picture the Venn
diagram of “A AND B”.)</p>
<p>One use of <code>cost()</code> is to lead with the cheapest (sparsest) iterator. Since our <code>advance</code> method always
steps with <code>left</code> first and our “AND” operator is commutative, we could have assigned <code>leftIterator</code>
to the lower-cost iterator to get a speed-up. (That’s what Lucene’s <code>ConjunctionDISI</code> class does.)</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 330;"><span class="line" id="L330"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L331"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">long</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">cost()</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L332"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Math</span><span style="color: #212121">.</span><span style="color: #6F42C1">min</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">leftIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">cost</span><span style="color: #24292EFF">()</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">rightIterator</span><span style="color: #212121">.</span><span style="color: #6F42C1">cost</span><span style="color: #24292EFF">());</span></span>
<span class="line" id="L333"><span style="color: #24292EFF">        }</span></span>
<span class="line" id="L334"><span style="color: #24292EFF">    }</span></span>
<span class="line empty-line" id="L335"></span>
<span class="line empty-line" id="L336"></span></code></pre>
      
        
        <p>We can reuse the custom similarity from <code>BooleanQueryIntro</code> to give our example term queries scores of <code>1</code> on a
match, rather than worrying about BM25 scores.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 338;"><span class="line" id="L338"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">private</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">static</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">class</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">CountMatchingClauseSimilarity</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">extends</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">SimilarityBase</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L339"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L340"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">protected</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">double</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">score</span><span style="color: #24292EFF">(</span><span style="color: #D32F2F">BasicStats</span><span style="color: #24292EFF"> stats</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">double</span><span style="color: #24292EFF"> freq</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">double</span><span style="color: #24292EFF"> docLen) {</span></span>
<span class="line" id="L341"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">1</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L342"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L343"></span>
<span class="line" id="L344"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L345"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">String</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">toString</span><span style="color: #24292EFF">() {</span></span>
<span class="line" id="L346"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&quot;Every match has a score of 1&quot;</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L347"><span style="color: #24292EFF">        }</span></span>
<span class="line empty-line" id="L348"></span>
<span class="line empty-line" id="L349"></span></code></pre>
      
        
        <p>While we didn’t look at it in <code>BooleanQueryIntro</code>, a custom similarity can also explain its scoring
methodology. In our case, we can pass along the explanation from the <code>toString</code> method.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 351;"><span class="line" id="L351"><span style="color: #24292EFF">        @</span><span style="color: #D32F2F">Override</span></span>
<span class="line" id="L352"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">protected</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">void</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">explain(</span><span style="color: #D32F2F">List&lt;</span><span style="color: #6F42C1">Explanation</span><span style="color: #D32F2F">&gt;</span><span style="color: #6F42C1"> subExpls</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #D32F2F">BasicStats</span><span style="color: #6F42C1"> stats</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #D32F2F">double</span><span style="color: #6F42C1"> freq</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #D32F2F">double</span><span style="color: #6F42C1"> docLen)</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L353"><span style="color: #24292EFF">            </span><span style="color: #1976D2">subExpls</span><span style="color: #212121">.</span><span style="color: #6F42C1">add</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">Explanation</span><span style="color: #212121">.</span><span style="color: #6F42C1">match</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">1</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">this</span><span style="color: #212121">.</span><span style="color: #6F42C1">toString</span><span style="color: #24292EFF">()));</span></span>
<span class="line" id="L354"><span style="color: #24292EFF">        }</span></span>
<span class="line" id="L355"><span style="color: #24292EFF">    }</span></span>
<span class="line empty-line" id="L356"></span>
<span class="line empty-line" id="L357"></span></code></pre>
      
        
        <h2 id="tying-it-all-together">Tying it all together</h2>

        
      
        
        <p>Let’s put our custom query type to work.</p>
<p>After indexing documents 0-999, we create a <code>twoAndFive</code> query, similar to what we did in <code>BooleanQueryIntro</code>,
but this time it’s using the logic implemented above.</p>
<p>When the <code>IndexSearcher</code> (or technically the <code>DefaultBulkScorer</code>) first calls <code>nextDoc</code> on our
<code>DocIdSetIterator</code>, the left iterator (“two) will step to its first match – document 2. Then the right (“five”)
iterator steps to its first match greater than or equal to 2 – document 5. Then the left iterator advances to
document 6. Then the right iterator advances to document 10. Finally, the left iterator advances to document 10
too, and we return it. (It’s the first hit in the returned <code>TopDocs</code>.)</p>
<p>The logic for the next (and every other) matching document is similar:</p>
<pre><code><pre class="shiki" style="background-color: transparent"><code ><span class="line"><span style="color: #24292EFF">left</span><span style="color: #D32F2F">=</span><span style="color: #1976D2">12</span></span>
<span class="line"><span style="color: #24292EFF">right</span><span style="color: #D32F2F">=</span><span style="color: #1976D2">15</span></span>
<span class="line"><span style="color: #24292EFF">left</span><span style="color: #D32F2F">=</span><span style="color: #1976D2">16</span></span>
<span class="line"><span style="color: #24292EFF">right</span><span style="color: #D32F2F">=</span><span style="color: #1976D2">20</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">&lt;--</span></span>
<span class="line"><span style="color: #24292EFF">left</span><span style="color: #D32F2F">=</span><span style="color: #1976D2">20</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">&lt;--</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">HIT</span></span></code></pre>
</code></pre>
<p>After returning the top 10 hits, we can take a look at the <code>explain</code> output to see the output from our
custom <code>Weight</code> and custom <code>Similarity</code>.</p>

        <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 382;"><span class="line" id="L382"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">public</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">static</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">void</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">main(</span><span style="color: #D32F2F">String</span><span style="color: #6F42C1">[] args)</span><span style="color: #24292EFF"> throws IOException {</span></span>
<span class="line" id="L383"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">Path</span><span style="color: #24292EFF"> tmpDir </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Files</span><span style="color: #212121">.</span><span style="color: #6F42C1">createTempDirectory</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">BooleanQueryIntro</span><span style="color: #212121">.</span><span style="color: #1976D2">class</span><span style="color: #212121">.</span><span style="color: #6F42C1">getSimpleName</span><span style="color: #24292EFF">());</span></span>
<span class="line" id="L384"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">try</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">Directory</span><span style="color: #24292EFF"> directory </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">FSDirectory</span><span style="color: #212121">.</span><span style="color: #6F42C1">open</span><span style="color: #24292EFF">(tmpDir);</span></span>
<span class="line" id="L385"><span style="color: #24292EFF">             </span><span style="color: #D32F2F">IndexWriter</span><span style="color: #24292EFF"> writer </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">IndexWriter(directory</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #D32F2F">new</span><span style="color: #6F42C1"> IndexWriterConfig())</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L386"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">for</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">String</span><span style="color: #24292EFF"> doc </span><span style="color: #D32F2F">:</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">createDocumentText(</span><span style="color: #1976D2">1000</span><span style="color: #6F42C1">)</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L387"><span style="color: #24292EFF">                </span><span style="color: #1976D2">writer</span><span style="color: #212121">.</span><span style="color: #6F42C1">addDocument</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">List</span><span style="color: #212121">.</span><span style="color: #6F42C1">of</span><span style="color: #24292EFF">(</span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">TextField(</span><span style="color: #22863A">&quot;text&quot;</span><span style="color: #212121">,</span><span style="color: #6F42C1"> doc</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #1976D2">Field</span><span style="color: #212121">.</span><span style="color: #1976D2">Store</span><span style="color: #212121">.</span><span style="color: #1976D2">NO</span><span style="color: #6F42C1">)</span><span style="color: #24292EFF">));</span></span>
<span class="line" id="L388"><span style="color: #24292EFF">            }</span></span>
<span class="line empty-line" id="L389"></span>
<span class="line" id="L390"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">try</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">IndexReader</span><span style="color: #24292EFF"> reader </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">DirectoryReader</span><span style="color: #212121">.</span><span style="color: #6F42C1">open</span><span style="color: #24292EFF">(writer)) {</span></span>
<span class="line" id="L391"><span style="color: #24292EFF">                </span><span style="color: #D32F2F">IndexSearcher</span><span style="color: #24292EFF"> searcher </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">IndexSearcher(reader)</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L392"><span style="color: #24292EFF">                </span><span style="color: #1976D2">searcher</span><span style="color: #212121">.</span><span style="color: #6F42C1">setSimilarity</span><span style="color: #24292EFF">(</span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">CountMatchingClauseSimilarity()</span><span style="color: #24292EFF">);</span></span>
<span class="line empty-line" id="L393"></span>
<span class="line" id="L394"><span style="color: #24292EFF">                </span><span style="color: #D32F2F">BinaryAndQuery</span><span style="color: #24292EFF"> twoAndFive </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">BinaryAndQuery(</span></span>
<span class="line" id="L395"><span style="color: #6F42C1">                        </span><span style="color: #D32F2F">new</span><span style="color: #6F42C1"> TermQuery(</span><span style="color: #D32F2F">new</span><span style="color: #6F42C1"> Term(</span><span style="color: #22863A">&quot;text&quot;</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #22863A">&quot;two&quot;</span><span style="color: #6F42C1">))</span><span style="color: #212121">,</span></span>
<span class="line" id="L396"><span style="color: #6F42C1">                        </span><span style="color: #D32F2F">new</span><span style="color: #6F42C1"> TermQuery(</span><span style="color: #D32F2F">new</span><span style="color: #6F42C1"> Term(</span><span style="color: #22863A">&quot;text&quot;</span><span style="color: #212121">,</span><span style="color: #6F42C1"> </span><span style="color: #22863A">&quot;five&quot;</span><span style="color: #6F42C1">))</span></span>
<span class="line" id="L397"><span style="color: #6F42C1">                )</span><span style="color: #24292EFF">;</span></span>
<span class="line" id="L398"><span style="color: #24292EFF">                </span><span style="color: #1976D2">System</span><span style="color: #212121">.</span><span style="color: #1976D2">out</span><span style="color: #212121">.</span><span style="color: #6F42C1">println</span><span style="color: #24292EFF">(twoAndFive);</span></span>
<span class="line" id="L399"><span style="color: #24292EFF">                </span><span style="color: #D32F2F">TopDocs</span><span style="color: #24292EFF"> topDocs </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">searcher</span><span style="color: #212121">.</span><span style="color: #6F42C1">search</span><span style="color: #24292EFF">(twoAndFive</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">10</span><span style="color: #24292EFF">);</span></span>
<span class="line" id="L400"><span style="color: #24292EFF">                </span><span style="color: #D32F2F">for</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">ScoreDoc</span><span style="color: #24292EFF"> scoreDoc </span><span style="color: #D32F2F">:</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">topDocs</span><span style="color: #212121">.</span><span style="color: #1976D2">scoreDocs</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L401"><span style="color: #24292EFF">                    </span><span style="color: #1976D2">System</span><span style="color: #212121">.</span><span style="color: #1976D2">out</span><span style="color: #212121">.</span><span style="color: #6F42C1">println</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">scoreDoc</span><span style="color: #212121">.</span><span style="color: #1976D2">doc</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">+</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&quot;  &quot;</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">+</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">scoreDoc</span><span style="color: #212121">.</span><span style="color: #1976D2">score</span><span style="color: #24292EFF">);</span></span>
<span class="line" id="L402"><span style="color: #24292EFF">                }</span></span>
<span class="line empty-line" id="L403"></span>
<span class="line empty-line" id="L404"></span>
<span class="line" id="L405"><span style="color: #24292EFF">                </span><span style="color: #1976D2">System</span><span style="color: #212121">.</span><span style="color: #1976D2">out</span><span style="color: #212121">.</span><span style="color: #6F42C1">println</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">searcher</span><span style="color: #212121">.</span><span style="color: #6F42C1">explain</span><span style="color: #24292EFF">(twoAndFive</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">20</span><span style="color: #24292EFF">));</span></span>
<span class="line" id="L406"><span style="color: #24292EFF">                </span><span style="color: #C2C3C5">/*</span></span>
<span class="line" id="L407"><span style="color: #C2C3C5">                2.0 = sum of:</span></span>
<span class="line" id="L408"><span style="color: #C2C3C5">                  1.0 = weight(text:two in 20) [CountMatchingClauseSimilarity], result of:</span></span>
<span class="line" id="L409"><span style="color: #C2C3C5">                    1.0 = score(CountMatchingClauseSimilarity, freq=1.0), computed from:</span></span>
<span class="line" id="L410"><span style="color: #C2C3C5">                      1 = Every match has a score of 1</span></span>
<span class="line" id="L411"><span style="color: #C2C3C5">                  1.0 = weight(text:five in 20) [CountMatchingClauseSimilarity], result of:</span></span>
<span class="line" id="L412"><span style="color: #C2C3C5">                    1.0 = score(CountMatchingClauseSimilarity, freq=1.0), computed from:</span></span>
<span class="line" id="L413"><span style="color: #C2C3C5">                      1 = Every match has a score of 1</span></span>
<span class="line" id="L414"><span style="color: #C2C3C5">                */</span></span>
<span class="line empty-line" id="L415"></span>
<span class="line" id="L416"><span style="color: #24292EFF">                </span><span style="color: #1976D2">System</span><span style="color: #212121">.</span><span style="color: #1976D2">out</span><span style="color: #212121">.</span><span style="color: #6F42C1">println</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">searcher</span><span style="color: #212121">.</span><span style="color: #6F42C1">explain</span><span style="color: #24292EFF">(twoAndFive</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">22</span><span style="color: #24292EFF">));</span></span>
<span class="line" id="L417"><span style="color: #24292EFF">                </span><span style="color: #C2C3C5">/*</span></span>
<span class="line" id="L418"><span style="color: #C2C3C5">                0.0 = no match on required clause (text:five)</span></span>
<span class="line" id="L419"><span style="color: #C2C3C5">                  0.0 = no matching term</span></span>
<span class="line" id="L420"><span style="color: #C2C3C5">                */</span></span>
<span class="line" id="L421"><span style="color: #24292EFF">            }</span></span>
<span class="line" id="L422"><span style="color: #24292EFF">        } </span><span style="color: #D32F2F">finally</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L423"><span style="color: #24292EFF">            </span><span style="color: #D32F2F">for</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">String</span><span style="color: #24292EFF"> indexFile </span><span style="color: #D32F2F">:</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">FSDirectory</span><span style="color: #212121">.</span><span style="color: #6F42C1">listAll</span><span style="color: #24292EFF">(tmpDir)) {</span></span>
<span class="line" id="L424"><span style="color: #24292EFF">                </span><span style="color: #1976D2">Files</span><span style="color: #212121">.</span><span style="color: #6F42C1">deleteIfExists</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">tmpDir</span><span style="color: #212121">.</span><span style="color: #6F42C1">resolve</span><span style="color: #24292EFF">(indexFile));</span></span>
<span class="line" id="L425"><span style="color: #24292EFF">            }</span></span>
<span class="line" id="L426"><span style="color: #24292EFF">            </span><span style="color: #1976D2">Files</span><span style="color: #212121">.</span><span style="color: #6F42C1">deleteIfExists</span><span style="color: #24292EFF">(tmpDir);</span></span>
<span class="line" id="L427"><span style="color: #24292EFF">        }</span></span>
<span class="line" id="L428"><span style="color: #24292EFF">    }</span></span>
<span class="line empty-line" id="L429"></span>
<span class="line empty-line" id="L430"></span>
<span class="line" id="L431"><span style="color: #24292EFF">}</span></span>
<span class="line empty-line" id="L432"></span>
<span class="line empty-line" id="L433"></span></code></pre>
      
    </div>
    <footer>
      <div>
        Generated by <a href="https://github.com/mercmobily/docco">Docco</a>
      </div>
    </footer>
  </div>
</body>
</html>
